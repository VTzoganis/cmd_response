<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Project Goals &mdash; cmd_response 2014_01 documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2014_01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="cmd_response 2014_01 documentation" href="index.html" />
    <link rel="up" title="Table of Contents" href="contents.html" />
    <link rel="next" title="USB command interface" href="commands.html" />
    <link rel="prev" title="Table of Contents" href="contents.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="commands.html" title="USB command interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="contents.html" title="Table of Contents"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">cmd_response 2014_01 documentation</a> &raquo;</li>
          <li><a href="contents.html" accesskey="U">Table of Contents</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Project Goals</a><ul>
<li><a class="reference internal" href="#main-goals">Main Goals</a><ul>
<li><a class="reference internal" href="#conserve-sram">conserve SRAM</a></li>
<li><a class="reference internal" href="#short-commands">short commands</a></li>
<li><a class="reference internal" href="#additional-rules-for-the-interface">additional rules for the interface</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-operations">Basic Operations</a></li>
<li><a class="reference internal" href="#signal-averaging">Signal Averaging</a></li>
<li><a class="reference internal" href="#startup">Startup</a></li>
<li><a class="reference internal" href="#configuration-check">Configuration Check</a></li>
<li><a class="reference internal" href="#epicsduino">epicsduino</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="contents.html"
                        title="previous chapter">Table of Contents</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="commands.html"
                        title="next chapter">USB command interface</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/theory.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="project-goals">
<span id="theory"></span><span id="index-0"></span><h1>Project Goals<a class="headerlink" href="#project-goals" title="Permalink to this headline">¶</a></h1>
<div class="section" id="main-goals">
<h2>Main Goals<a class="headerlink" href="#main-goals" title="Permalink to this headline">¶</a></h2>
<p>The main goal of this project is to present
the <strong>Arduino as an I/O controller</strong> using a
command-response communications language
over the USB port.  The code should run on
any Arduino with a USB port.  The code
should provide access to the basic I/O
capabilities of the Arduino.</p>
<div class="section" id="conserve-sram">
<h3>conserve SRAM<a class="headerlink" href="#conserve-sram" title="Permalink to this headline">¶</a></h3>
<p>To fit the code into the smaller SRAM space of
Arduino models such as the Uno R3 (a 2k space),
all strings were coded as <tt class="docutils literal"><span class="pre">char</span> <span class="pre">*</span></tt> rather
than use <tt class="docutils literal"><span class="pre">String</span></tt> <a class="footnote-reference" href="#id2" id="id1">[1]</a> objects.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://arduino.cc/en/Reference/StringObject">http://arduino.cc/en/Reference/StringObject</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="short-commands">
<h3>short commands<a class="headerlink" href="#short-commands" title="Permalink to this headline">¶</a></h3>
<p>One objective of <strong>cmd_response</strong>
was to make basic read and write commands
very short, to simplify typing at some interactive
terminal.
(For a similar project using SCPI <a class="footnote-reference" href="#scpi" id="id3">[4]</a> commands, see <a class="reference internal" href="#epicsduino"><em>epicsduino</em></a>.)
The USB commands have this form:</p>
<div class="highlight-python"><pre>//  USB command interface of form: baseCmd [arg1 [arg2]]
//
// char* baseCmd (lower case)
// long arg1, arg2 (no octal or hex interpreted)</pre>
</div>
</div>
<div class="section" id="additional-rules-for-the-interface">
<h3>additional rules for the interface<a class="headerlink" href="#additional-rules-for-the-interface" title="Permalink to this headline">¶</a></h3>
<p>Additionally, these rules were used to
build the interface:</p>
<ul class="simple">
<li>Commands either <strong>get</strong> (start with <tt class="docutils literal"><span class="pre">?</span></tt>)
or <strong>set</strong> (start with <tt class="docutils literal"><span class="pre">!</span></tt>) a value.</li>
<li>All <a class="reference internal" href="commands.html#commands"><em>commands</em></a> received should return a response.</li>
<li>No automatic command echo is provided.</li>
<li>All <strong>set</strong> commands return &#8220;Ok&#8221; or an error message.</li>
<li>All <strong>get</strong> commands return a value or an error message.</li>
<li>All <a class="reference internal" href="errors.html#errors"><em>Error messages</em></a> start with the text: <tt class="docutils literal"><span class="pre">ERROR_</span></tt></li>
<li>Most error messages will return the command text as a diagnostic.</li>
<li>The device provides a useful message on <a class="reference internal" href="basic_example.html#is-our-sketch-running"><em>startup</em></a>.</li>
<li>A software <a class="reference internal" href="commands.html#get-id"><em>identifier</em></a> can be queried.</li>
<li>A software <a class="reference internal" href="commands.html#get-version"><em>version</em></a> can be queried.</li>
<li>The version should be a string rather than an integer.</li>
</ul>
</div>
</div>
<div class="section" id="basic-operations">
<span id="basics"></span><h2>Basic Operations<a class="headerlink" href="#basic-operations" title="Permalink to this headline">¶</a></h2>
<p>The basic capabilities common to all Arduino boards
consist of:</p>
<ul class="simple">
<li>a number of digital (binary) input/output (configurable) channels</li>
<li>some of the digital channels have pulse-width modulation output capability</li>
<li>a number of analog input channels (10-bit analog-to-digital converter)</li>
</ul>
<p>The commands which support these basic operations are:
<a class="reference internal" href="commands.html#num-ai"><em>?#ai</em></a>, <a class="reference internal" href="commands.html#num-bi"><em>?#bi</em></a>, <a class="reference internal" href="commands.html#get-ai"><em>?ai</em></a>,
<a class="reference internal" href="commands.html#get-bi"><em>?bi</em></a>, <a class="reference internal" href="commands.html#set-pin"><em>!pin</em></a>, <a class="reference internal" href="commands.html#set-bo"><em>!bo</em></a>,
and <a class="reference internal" href="commands.html#set-pwm"><em>!pwm</em></a>.</p>
</div>
<div class="section" id="signal-averaging">
<span id="averaging"></span><span id="index-1"></span><h2>Signal Averaging<a class="headerlink" href="#signal-averaging" title="Permalink to this headline">¶</a></h2>
<p>It takes a few dozen <a class="footnote-reference" href="#id5" id="id4">[2]</a> microseconds to read each
analog input channel, much faster than typical
communications over USB to request and retrieve
a value.  Averaging the analog values over a
fixed period makes sense.</p>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td><p class="first">The actual time to convert the ADC signal
is dependent on several factors, including
the signal level itself.  For more information,
see: <a class="reference external" href="http://arduino.cc/en/Reference/AnalogRead">http://arduino.cc/en/Reference/AnalogRead</a></p>
<p class="last">On the Mega2560, the rate with no watched channels
was reported as 25841/s.  Watching just one
channel, the reported rate dropped to 6567/s.
For two channels, the reported rate was 3781/s.</p>
</td></tr>
</tbody>
</table>
<p>The signal averages are available from the
command interface with <a class="reference internal" href="commands.html#ai-mean"><em>?ai:mean</em></a>,
in addition to the
instantaneous values available with the
<a class="reference internal" href="commands.html#get-ai"><em>?ai</em></a> command.  However, since it takes
valuable time to read these analog signals,
only the desired channels should be averaged,
to optimize for speed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A channel must be
configured (with <a class="reference internal" href="commands.html#watch-ai"><em>!ai:watch</em></a>)
before calling <a class="reference internal" href="commands.html#ai-mean"><em>?ai:mean</em></a>.</p>
</div>
<p id="index-2">The average for each channel is obtained by
accumulating measurements of the analog input,
<span class="math">\(a_i\)</span> until the update period has elapsed,</p>
<p><span class="math">\((k/n) \sum_i^n a_i\)</span>.</p>
<p>The total number of values accumulated during
each period, <span class="math">\(n\)</span>, is combined with the
period length, <span class="math">\(t\)</span> to compute the update
rate (returned by <a class="reference internal" href="commands.html#get-rate"><em>?rate</em></a>),</p>
<p><span class="math">\(n / t\)</span>.</p>
<p>The average value has higher precision than the
instantaneous value.  Exactly how much higher
is empirical.  Some external control systems
expect <em>raw</em> (integer) values from I/O controllers.
With such raw numbers, the external control system
will apply automatically pre-configured scaling
factors to place the number into engineering units,
such as <em>VDC</em>.</p>
<p id="index-3">Here, a positive multiplier, <span class="math">\(k\)</span>, is used
to scale the average value so that its limit
of precision can be expressed as a <em>long</em> integer.
To request the value of <span class="math">\(k\)</span>, use <a class="reference internal" href="commands.html#get-k"><em>?k</em></a>.
To request the value of <span class="math">\(k\)</span>, use <a class="reference internal" href="commands.html#set-k"><em>!k</em></a>.
Limits of <span class="math">\(k\)</span> are found by requesting
<a class="reference internal" href="commands.html#get-k-min"><em>?k:min</em></a> and <a class="reference internal" href="commands.html#get-k-max"><em>?k:max</em></a>.</p>
<p id="index-4">All <strong>watched channels</strong> are accumulated during each
averaging period.  The averages (for just the watched channels)
and update rate are recomputed <em>only</em> at the end of each period.</p>
</div>
<div class="section" id="startup">
<h2>Startup<a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h2>
<p>On startup, the device will output a message such
as this to the USB port:</p>
<div class="highlight-python"><pre>cmd_response started: 7113</pre>
</div>
<p>This message (from an Arduino Mega2560) signifies
the device is <em>running</em> and the <strong>cmd_response</strong>
interface code is ready to receive a
command and return a response.
The number <tt class="docutils literal"><span class="pre">7113</span></tt> is the amount of free
SRAM available on startup.  On the Uno R3, the number
is ca. 1700, meaning there is still plenty of
SRAM available.</p>
<p>If this startup message does not appear.
the device is not ready for communications
and something is wrong.  The logical list
to check starts with the values in the
Communication Parameters (given
in <a class="reference internal" href="commands.html#comm-parms"><em>Communications Parameters</em></a>).  If the problem persists,
check the external host&#8217;s USB port,
the FTDI driver on the external host,
read/write permissions to the USB port, and
the USB cable.  If the problem still persists,
question that the Arduino is running
the <strong>cmd_response</strong> code.</p>
</div>
<div class="section" id="configuration-check">
<h2>Configuration Check<a class="headerlink" href="#configuration-check" title="Permalink to this headline">¶</a></h2>
<p>It can be useful for an external control system
to verify which controller is communicating.
Two commands are provided to identify
this software (<a class="reference internal" href="commands.html#get-id"><em>?id</em></a>) and
version (<a class="reference internal" href="commands.html#get-version"><em>?v</em></a>).</p>
</div>
<div class="section" id="epicsduino">
<span id="index-5"></span><span id="id6"></span><h2>epicsduino<a class="headerlink" href="#epicsduino" title="Permalink to this headline">¶</a></h2>
<p>The <strong>epicsduino</strong> project of Keenan Lang
at the Advanced Photon Source <a class="footnote-reference" href="#id9" id="id7">[3]</a>
is <em>very</em> similar to this project as it was developed in parallel to
this project.
In the <strong>epicsduino</strong> project, an SCPI command interface <a class="footnote-reference" href="#scpi" id="id8">[4]</a> is
constructed using String objects.  This interface consumes significant
SRAM and thus limits the features which can be implemented in the interface
language and also limits the Arduino models on which the sketch can be used.
Also, the SCPI commands are longer, and take more time to parse.</p>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td><strong>epicsduino</strong>: <a class="reference external" href="https://subversion.xray.aps.anl.gov/bcdaioc/projects/epicsduino">https://subversion.xray.aps.anl.gov/bcdaioc/projects/epicsduino</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="scpi" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id8">2</a>)</em> SCPI: <a class="reference external" href="http://www.ivifoundation.org/scpi/default.aspx">http://www.ivifoundation.org/scpi/default.aspx</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="commands.html" title="USB command interface"
             >next</a> |</li>
        <li class="right" >
          <a href="contents.html" title="Table of Contents"
             >previous</a> |</li>
        <li><a href="index.html">cmd_response 2014_01 documentation</a> &raquo;</li>
          <li><a href="contents.html" >Table of Contents</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013,2014 Pete R Jemian.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>