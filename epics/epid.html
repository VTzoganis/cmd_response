

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Example: Feedback using the epid record &mdash; cmd_response 2014.0521.0
 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2014.0521.0
',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="cmd_response 2014.0521.0
 documentation" href="../index.html" />
    <link rel="up" title="Example: Constant Lighting with EPICS" href="index.html" />
    <link rel="next" title="Installation, Downloads, Licensing" href="../install.html" />
    <link rel="prev" title="CSS BOY screen" href="cssboy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../install.html" title="Installation, Downloads, Licensing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cssboy.html" title="CSS BOY screen"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">cmd_response 2014.0521.0
 documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Table of Contents</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Example: Constant Lighting with EPICS</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Example: Feedback using the <tt class="docutils literal"><span class="pre">epid</span></tt> record</a><ul>
<li><a class="reference internal" href="#basic-pid-theory">Basic PID Theory</a></li>
<li><a class="reference internal" href="#outline">Outline</a></li>
<li><a class="reference internal" href="#definition-of-terms">Definition of Terms</a></li>
<li><a class="reference internal" href="#configuration-of-epid">Configuration of <em>epid</em></a></li>
<li><a class="reference internal" href="#adjusting-and">Adjusting <span class="math">\(K_p\)</span>, <span class="math">\(K_i\)</span>, and <span class="math">\(K_d\)</span></a></li>
<li><a class="reference internal" href="#measure-the-system-response">Measure the System Response</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cssboy.html"
                        title="previous chapter">CSS BOY screen</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../install.html"
                        title="next chapter">Installation, Downloads, Licensing</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/epics/epid.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="example-feedback-using-the-epid-record">
<span id="epid-example"></span><span id="index-0"></span><h1>Example: Feedback using the <tt class="docutils literal"><span class="pre">epid</span></tt> record<a class="headerlink" href="#example-feedback-using-the-epid-record" title="Permalink to this headline">¶</a></h1>
<p id="index-1">This example builds on the previous example where a sensor
creating a <em>signal</em> was connected to the Arduino and monitored
from EPICS.  An LED was connected to the Arduino to
<em>control</em> (or modify) the first signal.</p>
<p id="index-2">This example will control the output of the LED based on the signal from the sensor.
We&#8217;ll test our controls by changing the background lighting levels and the
desired signal level from the sensor.  In effect, we are building
<strong>constant lighting</strong> (maintaining a constant level of illumination).</p>
<p>Requirements:</p>
<ul class="simple">
<li>Arduino system with specified electronics circuit (<a class="reference internal" href="../circuit/index.html#example-circuit"><em>Electronic Circuit: photocell and LED</em></a>)</li>
<li>Linux computer with Arduino interface</li>
<li>EPICS IOC configured to communicate with Arduino</li>
<li>CSS BOY client for EPICS <a class="footnote-reference" href="#id9" id="id1">[1]</a></li>
</ul>
<p>The EPICS <em>epid</em> record <a class="footnote-reference" href="#epid" id="id2">[2]</a> is used to continuously update the
<em>control</em> based on updates to the <em>signal</em> with the goal of
driving the signal to a desired <em>set point</em>.  The <em>epid</em> record
provides an extended Proportional-Integral-Derivative controller
(for more information about PID control, see, for example,
these documents from the University of
Michigan: <a class="footnote-reference" href="#id10" id="id3">[3]</a>, <a class="footnote-reference" href="#id11" id="id4">[4]</a>, <a class="footnote-reference" href="#umich" id="id5">[5]</a>) to a process configured by EPICS PVs.
Additional equations are sketched out <a class="footnote-reference" href="#id12" id="id6">[6]</a> that convert the terms
of the UMich documentation into terms of the <em>epid</em> record.</p>
<div class="section" id="basic-pid-theory">
<span id="index-3"></span><h2>Basic PID Theory<a class="headerlink" href="#basic-pid-theory" title="Permalink to this headline">¶</a></h2>
<p id="index-4">At its heart, PID control is implemented to maintain a time-dependent,
measured signal, <span class="math">\(M(t)\)</span>, at a desired value, <span class="math">\(D(t)\)</span>
by adjusting a control, <span class="math">\(Y(t)\)</span>.  The general PID equation is based
on the concept of a <em>process error</em>, <span class="math">\(\epsilon(t)\)</span>, that is the
difference between the actual and desired values of the signal:</p>
<div class="math">
\[\epsilon(t) = M(t) - D(t)\]</div>
<p>general PID equation (<a class="footnote-reference" href="#umich" id="id7">[5]</a>):</p>
<div class="math">
\[Y(t) = K_c \left[ { \epsilon(t) + {1 \over T_i}\int_0^t \epsilon(t_i)d{t_i} + T_d {d\epsilon(t) \over dt} } \right] + Y(t_0)\]</div>
<p><em>epid</em> record PID equation (<a class="footnote-reference" href="#epid" id="id8">[2]</a>):</p>
<div class="math">
\[Y_n = K_P \epsilon(t) + K_P K_I \sum_i {\epsilon_i \delta t_i} + K_P K_D {\epsilon_n - \epsilon_{n-1} \over \delta t_n}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The process error, <span class="math">\(\epsilon(t)\)</span>, is also
known as various other names, such as <em>following error</em>.</p>
</div>
</div>
<div class="section" id="outline">
<h2>Outline<a class="headerlink" href="#outline" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="definition-of-terms">
<h2>Definition of Terms<a class="headerlink" href="#definition-of-terms" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils" id="index-5">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">term</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><span class="math">\(t\)</span></td>
<td>time</td>
</tr>
<tr class="row-odd"><td><span class="math">\(M(t)\)</span></td>
<td>measured input <strong>signal</strong> as a function of time</td>
</tr>
<tr class="row-even"><td><span class="math">\(D(t)\)</span></td>
<td><strong>set point</strong> (desired value of <strong>signal</strong>) as a function of time</td>
</tr>
<tr class="row-odd"><td><span class="math">\(Y(t)\)</span></td>
<td>chosen <strong>control</strong> output as a function of time</td>
</tr>
<tr class="row-even"><td><span class="math">\(\epsilon(t)\)</span></td>
<td><strong>process error</strong>: <span class="math">\(\epsilon(t) = M(t) - D(t)\)</span></td>
</tr>
<tr class="row-odd"><td><span class="math">\(K\)</span></td>
<td>generalized process <strong>gain</strong>:  <span class="math">\(K = {\hbox{change in output} \over \hbox{change in input}}\)</span></td>
</tr>
<tr class="row-even"><td><span class="math">\(K_c\)</span></td>
<td>process <strong>gain</strong> constant (from theory, to be determined empirically)</td>
</tr>
<tr class="row-odd"><td><span class="math">\(T_i\)</span></td>
<td>process integral coefficient (from theory, to be determined empirically)</td>
</tr>
<tr class="row-even"><td><span class="math">\(T_d\)</span></td>
<td>process derivative coefficient (from theory, to be determined empirically)</td>
</tr>
<tr class="row-odd"><td><span class="math">\(K_P\)</span></td>
<td>proportional gain coefficient (EPICS user input):  <span class="math">\(K_P = K_C\)</span></td>
</tr>
<tr class="row-even"><td><span class="math">\(K_I\)</span></td>
<td>integral gain coefficient (EPICS user input):  <span class="math">\(K_I = {K_C / T_i}\)</span></td>
</tr>
<tr class="row-odd"><td><span class="math">\(K_D\)</span></td>
<td>derivative gain coefficient (EPICS user input):  <span class="math">\(K_D = K_C T_d\)</span></td>
</tr>
<tr class="row-even"><td><span class="math">\(\tau\)</span></td>
<td>time for response to complete</td>
</tr>
<tr class="row-odd"><td><span class="math">\(\tau_d\)</span></td>
<td>dead time before system starts to respond</td>
</tr>
<tr class="row-even"><td><span class="math">\(\delta t\)</span></td>
<td>time between samples</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="configuration-of-epid">
<span id="epid-configuration"></span><h2>Configuration of <em>epid</em><a class="headerlink" href="#configuration-of-epid" title="Permalink to this headline">¶</a></h2>
<p>-tba-</p>
</div>
<div class="section" id="adjusting-and">
<span id="adjust-pid-terms"></span><h2>Adjusting <span class="math">\(K_p\)</span>, <span class="math">\(K_i\)</span>, and <span class="math">\(K_d\)</span><a class="headerlink" href="#adjusting-and" title="Permalink to this headline">¶</a></h2>
<p>-tba-</p>
</div>
<div class="section" id="measure-the-system-response">
<span id="measure-system-response"></span><h2>Measure the System Response<a class="headerlink" href="#measure-the-system-response" title="Permalink to this headline">¶</a></h2>
<p>Once the PID parameters are adjusted for the local particulars,
the performance can be demonstrated by charting <span class="math">\(D(t)\)</span>,
<span class="math">\(M(t)\)</span>, and <span class="math">\(Y(t)\)</span>.  The next figure shows such
a chart for a few days in January, Chicago area.</p>
<div class="figure align-center">
<img alt="fig.CSSBOY_epid_chart" src="../_images/CSSBOY_epid_chart.png" style="width: 50%;" />
<p class="caption">Example operation of <em>epid</em> feedback for several days
(<a class="reference download internal" href="../_downloads/CSSBOY_epid_chart.png"><tt class="xref download docutils literal"><span class="pre">CSSBOY_epid_chart.png</span></tt></a>).  Colors:
<span class="math">\(D(t)\)</span> (set point, blue),
<span class="math">\(M(t)\)</span> (photocell, red),
<span class="math">\(Y(t)\)</span> (LED, green)</p>
</div>
<div class="sidebar">
<p class="first sidebar-title">Average <span class="math">\(Y(t)\)</span></p>
<p>Here, we say <span class="math">\(Y(t)\)</span> when we actually refer the
time-averaged <span class="math">\(\left&lt;Y(t)\right&gt;\)</span> reported as <em>mean V_LED, VDC</em>.
The instantaneous V_LED takes the values of 0 or <span class="math">\(V_{cc}\)</span>
as the PWM modulates the apparent brightness of the LED.</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">PWM:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://arduino.cc/en/Tutorial/PWM">http://arduino.cc/en/Tutorial/PWM</a></li>
<li><a class="reference external" href="http://arduino.cc/en/Tutorial/SecretsOfArduinoPWM">http://arduino.cc/en/Tutorial/SecretsOfArduinoPWM</a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<p>The chart, at first, shows steady-state operations of a tuned PID loop.
With <span class="math">\(M(t)=\mbox{1.3}\)</span>, the loop varies the LED brightness (<span class="math">\(Y(t)\)</span>)
to hold <span class="math">\(M(t)\)</span> steady.  At night, the LED is brightest.  During the day,
the LED brightness is reduced to maintain the chosen set point.</p>
<p>Some time on 01-28, the <em>epid</em> feedback was turned off (manually) and
<span class="math">\(Y(t)\)</span> was set to zero.  In this case, the ambient light level
is recorded by <span class="math">\(M(t)\)</span>.  On 01-29, <span class="math">\(D(t)\)</span> was also set to zero.
Since the <em>epid</em> loop was off, this change had not effect.  Note that in
the overnight period, the sensor was not able to detect variations in
the ambient darkness.  Selection of different resistors would improve the
nighttime sensitivity but that is for a different project.  With the
feedback on, the signal is within range of both the photocell and the
LED such that <span class="math">\(Y(t)\)</span> can be used to correlate lighting conditions
at any time of day or night.</p>
<p>Later on 01-29, the <em>epid</em> feedback was resumed and the loop locked in
within the charted sampling period.  Actual time for lockin with the terms
shown was within 10 seconds.</p>
<p>Spikes in the photocell signal, <span class="math">\(M(t)\)</span>, appear on 01-30 and are
likely due to USB communications errors between EPICS and the Arduino.
The short-lived spikes have no obvious effect on the <em>epid</em> operations.</p>
<p>The variations of <span class="math">\(Y(t)\)</span> on 01-30 correlate with ambient conditions
on that day (reflections from passing traffic, lighting, weather) and indicate
the response of the <em>epid</em> controls to changing conditions as it
maintains the chosen set point.</p>
<p>When <em>epid</em> feedback is turned on, the lighting level is held constant.
At this point, we declare <em>success</em> and finish this document.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>CSS BOY, <a class="reference external" href="http://ics-web.sns.ornl.gov/css/products.html">http://ics-web.sns.ornl.gov/css/products.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="epid" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id8">2</a>)</em> <a class="reference external" href="http://cars9.uchicago.edu/software/epics/epidRecord.html">http://cars9.uchicago.edu/software/epics/epidRecord.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://controls.engin.umich.edu/wiki/index.php/Main_Page#PID_control">https://controls.engin.umich.edu/wiki/index.php/Main_Page#PID_control</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="https://controls.engin.umich.edu/wiki/index.php/Main_Page">https://controls.engin.umich.edu/wiki/index.php/Main_Page</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="umich" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><em>(<a class="fn-backref" href="#id5">1</a>, <a class="fn-backref" href="#id7">2</a>)</em> <a class="reference external" href="https://controls.engin.umich.edu/wiki/index.php/PIDTuningClassical">https://controls.engin.umich.edu/wiki/index.php/PIDTuningClassical</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>notes: <a class="reference download internal" href="../_downloads/131108115836_0001.pdf"><tt class="xref download docutils literal"><span class="pre">131108115836_0001.pdf</span></tt></a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../install.html" title="Installation, Downloads, Licensing"
             >next</a> |</li>
        <li class="right" >
          <a href="cssboy.html" title="CSS BOY screen"
             >previous</a> |</li>
        <li><a href="../index.html">cmd_response 2014.0521.0
 documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Table of Contents</a> &raquo;</li>
          <li><a href="index.html" >Example: Constant Lighting with EPICS</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013,2014 Pete R Jemian.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>