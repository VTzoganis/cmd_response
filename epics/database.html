

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>EPICS database &mdash; cmd_response 2014.02.21 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2014.02.21',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="cmd_response 2014.02.21 documentation" href="../index.html" />
    <link rel="up" title="Example: Constant Lighting with EPICS" href="index.html" />
    <link rel="next" title="EPICS IOC startup commands" href="ioc.html" />
    <link rel="prev" title="Stream protocol" href="streams.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="ioc.html" title="EPICS IOC startup commands"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="streams.html" title="Stream protocol"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">cmd_response 2014.02.21 documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Table of Contents</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Example: Constant Lighting with EPICS</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">EPICS database</a><ul>
<li><a class="reference internal" href="#record-instances">record instances</a></li>
<li><a class="reference internal" href="#file-cmd-reponse-db">file: <tt class="docutils literal"><span class="pre">cmd_reponse.db</span></tt></a></li>
<li><a class="reference internal" href="#temperature-sensor">temperature sensor</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="streams.html"
                        title="previous chapter">Stream protocol</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ioc.html"
                        title="next chapter">EPICS IOC startup commands</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/epics/database.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="epics-database">
<span id="pv-database"></span><span id="index-0"></span><h1>EPICS database<a class="headerlink" href="#epics-database" title="Permalink to this headline">¶</a></h1>
<p>An EPICS database file is used to create specific record instances
that will be used by an IOC.  It declares them by defining the name
and EPICS record type.  The name can be fully declared, such as <em>time</em>
or can be completed later by expansion of a macro definition, such as
<em>$(P)cmd</em>.  The value of the macro will be specified in the IOC
startup script, either through a call to <em>dbLoadRecords()</em> or <em>dbLoadTemplate()</em>.</p>
<p>This file is written to be used by more than one IOC, so it uses
a common macro for the IOC prefix (<em>$(P)</em>).  In our example IOC,
we&#8217;ll call this database file as (noting <em>P</em> is set to <tt class="docutils literal"><span class="pre">como:cr:</span></tt>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">dbLoadRecords</span><span class="p">(</span><span class="s">&quot;$(CMD_RESPONSE)/cmd_response.db&quot;</span><span class="p">,</span><span class="s">&quot;P=como:cr:,PORT=usb0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(More on this in the section titled: <a class="reference internal" href="ioc.html#ioc-commands"><em>EPICS IOC startup commands</em></a>.)</p>
<div class="section" id="record-instances">
<h2>record instances<a class="headerlink" href="#record-instances" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="9%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">name</th>
<th class="head">RTYP</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$(P)ai0</span></tt></td>
<td>ai</td>
<td>read the raw photocell sensor, <span class="math">\(V_P\)</span></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$(P)ai0:mean</span></tt></td>
<td>ai</td>
<td>photocell sensor, <span class="math">\(V_P\)</span></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$(P)ai1</span></tt></td>
<td>ai</td>
<td>read the LED&#8217;s PWM &#8220;voltage&#8221;, <span class="math">\(V_{LED}\)</span></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$(P)ai1:mean</span></tt></td>
<td>ai</td>
<td>read LED &#8220;voltage&#8221;, <span class="math">\(V_{LED}\)</span></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$(P)ai2:mean</span></tt></td>
<td>ai</td>
<td>read temperature sensor, <span class="math">\(V_T\)</span> (see <a class="reference internal" href="#temperature-sensor"><em>temperature sensor</em></a>)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$(P)ai2:mean</span></tt></td>
<td>ai</td>
<td>read reference voltage, <span class="math">\(V_{cc}\)</span> (see <a class="reference internal" href="#temperature-sensor"><em>temperature sensor</em></a>)</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$(P)pwm11</span></tt></td>
<td>ao</td>
<td>set the LED brightness (effectively: set <span class="math">\(V_{LED}\)</span>)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$(P)rate</span></tt></td>
<td>ai</td>
<td>read the update rate</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$(P)period</span></tt></td>
<td>ao</td>
<td>set the averaging period, s</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$(P)epid</span></tt></td>
<td>epid</td>
<td>Feedback control (see <a class="reference internal" href="epid.html#epid-example"><em>Example: Feedback using the epid record</em></a>)</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$(P)cmd</span></tt></td>
<td>stringout</td>
<td>send command directly to Arduino and read response</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><em>RTYP</em>: EPICS record type</li>
</ul>
<p>Additional fields have been added as appropriate (from the examples shown in
<a class="reference internal" href="streams.html#streams-protocol"><em>Stream protocol</em></a>):</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">field</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>DESC</td>
<td>descriptive text about this record instance</td>
</tr>
<tr class="row-odd"><td>EGU</td>
<td>engineering units</td>
</tr>
<tr class="row-even"><td>PREC</td>
<td>display precision</td>
</tr>
<tr class="row-odd"><td>HOPR</td>
<td>high limit for display purposes</td>
</tr>
<tr class="row-even"><td>LOPR</td>
<td>low limit for display purposes</td>
</tr>
<tr class="row-odd"><td>DRVH</td>
<td>maximum allowed value</td>
</tr>
<tr class="row-even"><td>DRVL</td>
<td>minimum allowed value</td>
</tr>
<tr class="row-odd"><td>PINI</td>
<td>process the record instance when EPICS starts</td>
</tr>
<tr class="row-even"><td>SCAN</td>
<td>how frequently to process this record</td>
</tr>
<tr class="row-odd"><td>VAL</td>
<td>initial value for the record instance</td>
</tr>
</tbody>
</table>
<p>The <a class="reference external" href="http://cars9.uchicago.edu/software/epics/epidRecord.html">epid</a>
record instance will be explained in another section (<a class="reference internal" href="epid.html#epid-example"><em>Example: Feedback using the epid record</em></a>).</p>
</div>
<div class="section" id="file-cmd-reponse-db">
<h2>file: <tt class="docutils literal"><span class="pre">cmd_reponse.db</span></tt><a class="headerlink" href="#file-cmd-reponse-db" title="Permalink to this headline">¶</a></h2>
<p>The file is too large for this documentation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">EPICS database:</th><td class="field-body"><a class="reference download internal" href="../_downloads/cmd_response.db"><tt class="xref download docutils literal"><span class="pre">cmd_response.db</span></tt></a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="temperature-sensor">
<span id="index-1"></span><span id="id1"></span><h2>temperature sensor<a class="headerlink" href="#temperature-sensor" title="Permalink to this headline">¶</a></h2>
<p>It is easy to measure temperature so let&#8217;s add that.
A thermistor varies its resistance with temperature.
The temperature can be measured using a voltage divider circuit.</p>
<div class="figure align-center">
<img alt="fig.thermistor" src="../_images/thermistor.png" style="width: 70%;" />
<p class="caption">Voltage divider circuit with the thermistor
(<a class="reference download internal" href="../_downloads/thermistor.png"><tt class="xref download docutils literal"><span class="pre">thermistor.png</span></tt></a>)</p>
</div>
<p>We&#8217;ll connect the thermistor voltage signal, <span class="math">\(V_T\)</span>,
to the Arduino&#8217;s ANALOG IN A2 pin and the supply voltage, <span class="math">\(V_{cc}\)</span>,
to pin A3.  Having actual measurements of <span class="math">\(V_{cc}\)</span> will improve our
precision of temperature reporting.</p>
<p>For a 10 kOhm (<span class="math">\(R_{ref}=10\mbox{ kOhm}\)</span>)
negative temperature coefficient thermistor,
we&#8217;ll use a 10 kOhm
resistor (<span class="math">\(R_4=10\mbox{ kOhm}\)</span>) to balance the voltage divider
so that its response is most sensitive at its reference temperatue (25 C).
We measure the thermistor voltage, <span class="math">\(V_T\)</span>,
and calculate its resistance, <span class="math">\(R_T\)</span>:</p>
<div class="math">
\[R_T = R_4 { V_T / V_{cc} \over 1 - V_T / V_{cc} }\]</div>
<p>The temperature, <span class="math">\(T\)</span>, is a non-linear function of  <span class="math">\(R_T\)</span>.  Taking
<span class="math">\(r=ln(R_T / R_{ref})\)</span> as a reduced resistance term to simplify the math,
we use the <em>extended “Steinhart and Hart&#8221;</em> interpolation (<a class="footnote-reference" href="#vishay" id="id2">[1]</a>):</p>
<div class="math">
\[T = {1 \over A_1 + B_1 r + C_1 r^2 + D_1 r^3}\]</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It&#8217;s easier to do the computation in EPICS records
rather than the Arduino.</p>
</div>
<p>Using coefficients (Vishay thermistor, 10k NTC, <span class="math">\(\beta=3977\mbox{ K}\)</span>)
from the manufacturer&#8217;s data sheet <a class="footnote-reference" href="#vishay" id="id3">[1]</a>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>A1</td>
<td>3.354016E-03</td>
</tr>
<tr class="row-even"><td>B1</td>
<td>2.569850E-04</td>
</tr>
<tr class="row-odd"><td>C1</td>
<td>2.620131E-06</td>
</tr>
<tr class="row-even"><td>D1</td>
<td>6.383091E-08</td>
</tr>
</tbody>
</table>
<p>we can now compute a curve for the signal we expect to measure.
See the next figure:</p>
<div class="figure align-center">
<img alt="fig.ADC_vs_T_curve" src="../_images/ADC_vs_T_curve.png" style="width: 70%;" />
<p class="caption">Arduino ANALOG IN A2 units plotted as a function of temperature (F)
for 10k NTC, <span class="math">\(\beta=3977\mbox{ K}\)</span> thermistor.
(<a class="reference download internal" href="../_downloads/ADC_vs_T_curve.png"><tt class="xref download docutils literal"><span class="pre">ADC_vs_T_curve.png</span></tt></a>)</p>
</div>
<table class="docutils footnote" frame="void" id="vishay" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> <a class="reference external" href="http://www.vishay.com/product?docid=29049">http://www.vishay.com/product?docid=29049</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="ioc.html" title="EPICS IOC startup commands"
             >next</a> |</li>
        <li class="right" >
          <a href="streams.html" title="Stream protocol"
             >previous</a> |</li>
        <li><a href="../index.html">cmd_response 2014.02.21 documentation</a> &raquo;</li>
          <li><a href="../contents.html" >Table of Contents</a> &raquo;</li>
          <li><a href="index.html" >Example: Constant Lighting with EPICS</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013,2014 Pete R Jemian.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>